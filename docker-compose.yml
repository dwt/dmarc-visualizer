version: '3.7'
secrets:
  grafana_admin_password:
    file: secrets/grafana_admin_password.txt
services:
  parsedmarc:
    build: ./parsedmarc/
    volumes:
      - ./files:/input:ro
      - ./output_files:/output
    command: parsedmarc -c /parsedmarc.ini /input/*
    depends_on:
      - elasticsearch

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.6.0
    environment:
      - discovery.type=single-node

  # @see https://grafana.com/docs/grafana/latest/installation/docker/
  # @see https://grafana.com/docs/grafana/latest/installation/configure-docker/
  grafana:
    image: grafana/grafana:latest
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning/:/etc/grafana/provisioning/:ro
    ports:
      - 3000:3000
    secrets:
      - grafana_admin_password
    environment:
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel
      GF_SECURITY_ADMIN_PASSWORD__FILE: /var/run/grafana_admin_password
